$schema: "https://json-schema.org/draft/2020-12/schema"
description: Configuration for the sm-calling variant calling pipeline.

type: object
properties:
  caller:
    type: string
    enum: ["mutect2", "freebayes", "all"]
    description: Which variant caller(s) to run.

  ref:
    type: object
    properties:
      genome:
        type: string
        description: Path to reference genome FASTA.
      build:
        type: string
        enum: ["GRCh37", "GRCh38"]
        description: Reference genome build identifier.
    required: [genome, build]

  gatk_resources:
    type: object
    description: "GATK resource files. Required for Mutect2, optional for FreeBayes-only runs."
    properties:
      panel_of_normals:
        type: string
      af_only_gnomad:
        type: string
      common_biallelic_gnomad:
        type: string
    required: [panel_of_normals, af_only_gnomad, common_biallelic_gnomad]

  paths:
    type: object
    properties:
      samples:
        type: string
        description: Path to the samples TSV file.
      bam_folder:
        type: string
        description: Directory containing input BAM files.
      output_folder:
        type: string
        description: Root directory for pipeline outputs.
      log_subdir:
        type: string
        default: "logs"
      intervals_dir:
        type: string
        default: "analysis/intervals"
    required: [samples, bam_folder, output_folder]

  bam:
    type: object
    properties:
      file_extension:
        type: string
        default: ".merged.dedup.bqsr.bam"
    required: [file_extension]

  scatter:
    type: object
    properties:
      mode:
        type: string
        enum: ["chromosome", "interval", "none"]
      count:
        type: integer
        minimum: 1
        default: 400
      chromosomes:
        type: array
        items:
          type: string
    required: [mode]

  params:
    type: object
    properties:
      mutect2:
        type: object
        properties:
          genotype_germline_sites:
            type: boolean
            default: true
            description: "Emit germline sites (required for PureCN)."
          genotype_pon_sites:
            type: boolean
            default: true
            description: "Emit PoN sites (required for PureCN)."
          disable_adaptive_pruning:
            type: boolean
            default: true
            description: "Disable Mutect2 adaptive pruning to prevent silent dropout of low-AF somatic variants in tumor-normal mode (GATK issue #7232)."
          annotations:
            type: array
            items:
              type: string
            default: []
            description: "Extra --annotation flags for Mutect2."
          annotation_groups:
            type: array
            items:
              type: string
            default: []
            description: "Extra --annotation-group flags for Mutect2."
          extra:
            type: string
            default: ""
      freebayes:
        type: object
      bcftools_norm:
        type: object
      bcftools_stats:
        type: object
        properties:
          extra:
            type: string
            default: ""

  purecn:
    type: object
    properties:
      enabled:
        type: boolean
        default: false
        description: "Enable PureCN copy number analysis."
      genome:
        type: string
        enum: ["hg19", "hg38"]
        default: "hg38"
        description: "PureCN genome identifier."
      intervals_bed:
        type: string
        default: ""
        description: "BED file with capture bait coordinates."
      normaldb:
        type: string
        default: ""
        description: "Pre-built normalDB.rds (skip NormalDB.R if provided)."
      mapping_bias:
        type: string
        default: ""
        description: "Pre-built mapping_bias.rds."
      snp_blacklist:
        type: string
        default: ""
        description: "Optional simple repeats BED for SNP filtering."
      extra:
        type: string
        default: ""
        description: "Extra PureCN.R arguments."
      seed:
        type: integer
        default: 123
        description: "Random seed for PureCN."
      postoptimize:
        type: boolean
        default: true
        description: "Run PureCN post-optimization."

required: [caller, ref, paths, bam, scatter]
